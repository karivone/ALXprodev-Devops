#!/bin/bash

# List of Pokémon to fetch
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

BASE_URL="https://pokeapi.co/api/v2/pokemon"
ERROR_LOG="errors.txt"
> "$ERROR_LOG"  # Clear previous errors

# Function to fetch a single Pokémon's data
fetch_pokemon() {
  local name="$1"
  local output_file="${name}.json"
  local retries=0
  local success=0

  while [ $retries -lt 3 ]; do
    status_code=$(curl -s -w "%{http_code}" -o "$output_file" "$BASE_URL/$name")
    if [ "$status_code" -eq 200 ]; then
      echo "Fetched $name"
      success=1
      break
    else
      echo "Retry $((retries+1)) for $name failed (status: $status_code)"
      retries=$((retries + 1))
      sleep 2
    fi
  done

  if [ $success -eq 0 ]; then
    echo "[$(date)] Failed to fetch $name after 3 attempts. Status: $status_code" >> "$ERROR_LOG"
    rm -f "$output_file"
  fi
}

# Start background fetches and track jobs
for name in "${POKEMON_LIST[@]}"; do
  fetch_pokemon "$name" &
done

# Use `jobs` to list all running background jobs
echo "⏳ Currently running background jobs:"
jobs -l

# Wait for all background jobs to complete
echo "🔄 Waiting for all fetch tasks to finish..."
wait

echo "✅ All Pokémon fetch tasks completed."

# Check if there were any errors
if [ -s "$ERROR_LOG" ]; then
  echo "⚠️ Some fetches failed. See $ERROR_LOG for details."
else
  echo "🎉 All fetches succeeded!"
fi
